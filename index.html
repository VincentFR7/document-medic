<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataPad ‚Äì Corps M√©dical OMEGA</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
<style>
/* NE PAS CHANGER LE STYLE VISUEL PRINCIPAL (ajouts minimes pour corriger positionnements) */
body {
  margin: 0;
  font-family: 'Orbitron', sans-serif;
  background: #000;
  color: #00eaff;
  overflow-x: hidden;
}

/* Header */
header {
  text-align: center;
  font-size: 2rem;
  font-weight: bold;
  text-shadow: 0 0 10px #00eaff, 0 0 20px #007bff;
  border-bottom: 2px solid #00eaff;
  padding: 48px 20px 20px; /* augment√© padding-top pour √©viter superposition */
  margin: 10px auto;
  position: relative;
}

/* Logo flottant et tournant (ajust√©) */
#logo {
  position: absolute;
  top: 18px;
  left: 18px;
  width: 70px;
  animation: rotateLogoSide 8s linear infinite;
  filter: drop-shadow(0 0 8px rgba(0,234,255,0.35));
}
@keyframes rotateLogoSide {
  0% { transform: rotateY(0deg); }
  50% { transform: rotateY(180deg); }
  100% { transform: rotateY(360deg); }
}

/* Fond anim√© */
.background {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: -2;
  overflow: hidden;
}
.background img {
  position: absolute;
  width: 100%; height: 100%;
  object-fit: cover;
  opacity: 0;
  animation: fadeSlideshow 24s infinite;
}
.background img:nth-child(1) { animation-delay: 0s; }
.background img:nth-child(2) { animation-delay: 8s; }
.background img:nth-child(3) { animation-delay: 16s; }
@keyframes fadeSlideshow {
  0% { opacity: 0; } 10% { opacity: 1; } 30% { opacity: 1; } 40% { opacity: 0; } 100% { opacity: 0; }
}

/* Horloges de mission (centr√©es sous le header) */
.mission-timers {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 16px auto 6px;
  padding: 0 10px;
  z-index: 5;
  position: relative;
}
.mission-box {
  background: rgba(0, 10, 20, 0.6);
  border: 1px solid rgba(0,234,255,0.18);
  border-left: 2px solid #00eaff;
  border-right: 2px solid #00eaff;
  border-radius: 10px;
  padding: 10px 18px;
  width: 220px;
  box-shadow: 0 0 16px rgba(0,234,255,0.12);
  text-align: center;
  backdrop-filter: blur(4px);
}
.mission-box h3 {
  margin: 0 0 6px;
  font-size: 0.95rem;
  color: #9ef2ff;
  letter-spacing: 1px;
  text-shadow: 0 0 6px rgba(0,234,255,0.12);
}
.countdown {
  font-size: 1.3rem;
  font-weight: 800;
  color: #dffcff;
  text-shadow: 0 0 10px rgba(0,170,255,0.15);
}
.countdown.active {
  color: #ff5858;
  text-shadow: 0 0 12px #ff6464, 0 0 22px #ff2b2b;
  animation: pulseRed 1s infinite ease-in-out;
}
@keyframes pulseRed {
  0% { transform: scale(1); }
  50% { transform: scale(1.03); }
  100% { transform: scale(1); }
}

/* Boutons */
.button {
  display: block;
  width: 260px;
  margin: 15px auto;
  padding: 12px;
  background: rgba(0, 20, 40, 0.8);
  border: 2px solid #00eaff;
  color: #00eaff;
  text-align: center;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.button:hover {
  background: #00eaff;
  color: #000;
  box-shadow: 0 0 15px #00eaff;
}

/* Bloc info */
.info {
  text-align: center;
  margin: 30px auto;
  max-width: 600px;
  padding: 20px;
  background: rgba(0, 10, 20, 0.7);
  border: 1px solid #00eaff;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,234,255,0.3);
  font-size: 1.1rem;
  line-height: 1.6;
}
.info h2 {
  color: #00eaff;
  margin-bottom: 15px;
  font-size:1.5rem;
  text-shadow:0 0 8px #00eaff;
}

/* Texte d√©filant */
.marquee {
  width: 100%;
  overflow: hidden;
  white-space: nowrap;
  box-sizing: border-box;
  border-top: 1px solid #00eaff;
  border-bottom: 1px solid #00eaff;
  margin: 10px 0;
}
.marquee p {
  display: inline-block;
  padding-left: 100%;
  animation: scrollText 60s linear infinite;
  font-weight: bold;
}
@keyframes scrollText {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}

/* Bouton Discord */
.discord {
  display: inline-block;
  margin: 20px auto 40px;
  padding: 14px 22px;
  background: #5865F2;
  color: #fff;
  font-weight: bold;
  text-decoration: none;
  border-radius: 10px;
  box-shadow: 0 0 12px rgba(88,101,242,0.8);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.discord:hover {
  transform: scale(1.05);
  box-shadow: 0 0 18px rgba(88,101,242,1);
}

/* Viewer iframe */
#viewer {
  display: none;
  width: 100%;
  height: 100vh;
  position: fixed;
  top: 0; left: 0;
  z-index: 10;
  background: #000;
}
#viewer iframe {
  width:100%; height:100%; border:none;
}
#backBtn {
  position:absolute;
  top:15px; left:15px;
  background: rgba(0,20,40,0.9);
  color:#00eaff;
  border:2px solid #00eaff;
  border-radius:6px;
  padding:8px 14px;
  cursor:pointer;
  font-family:'Orbitron',sans-serif;
  font-weight:bold;
  z-index:20;
}
#backBtn:hover { background:#00eaff; color:#000; }

/* Scan holographique bleu */
.scan {
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,255,255,0.06);
  pointer-events:none;
  z-index:15;
  opacity:0;
}

/* Responsive */
@media screen and (max-width: 768px) {
  header { font-size:1.6rem; padding-top:40px; }
  .button { width:80%; padding:10px; font-size:1rem; }
  .info { width:90%; font-size:1rem; }
  .mission-timers { flex-direction: column; gap:12px; margin-top:90px; }
  .mission-box { width: 86%; max-width: 320px; }
}

/* --- Styles additionnels pour le modal auth (discrets) --- */
.auth-modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  display: none; align-items: center; justify-content: center; z-index: 100;
  background: rgba(0,0,0,0.6);
}
.auth-card {
  background: rgba(0,10,20,0.95); border: 2px solid #00eaff; padding: 18px; width: 360px; border-radius: 10px;
}
.auth-card h3 { margin-top: 0; color:#9ef2ff }
.auth-card input { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:2px solid #00eaff; background:transparent; color:#00eaff }
.auth-actions { display:flex; gap:8px; justify-content:space-between; align-items:center }
.small-link { color:#9ef2ff; cursor:pointer; text-decoration:underline }

/* Top menu (Profil & Membre) */
.top-menu { position:absolute; top:18px; right:18px; z-index:50; display:flex; gap:10px; align-items:center }
.top-left { position:absolute; top:18px; left:18px; z-index:50; display:flex; gap:10px; align-items:center }
.profile-pill { padding:8px 12px; border-radius:8px; border:1px solid rgba(0,234,255,0.12); background:rgba(0,10,20,0.6); cursor:pointer }

/* Public members list */
.member-list { position:fixed; top:70px; left:18px; max-height:60vh; overflow:auto; width:260px; background:rgba(0,10,20,0.7); border:1px solid #00eaff; padding:10px; border-radius:8px; display:none; z-index:60 }
.member-item { padding:6px; border-bottom:1px dashed rgba(0,234,255,0.06); font-size:0.95rem }
</style>
</head>
<body>

<div class="background">
  <img src="https://i.imgur.com/f7PWoZV.jpeg" alt="">
  <img src="https://i.imgur.com/APBvYRx.jpeg" alt="">
  <img src="https://i.imgur.com/18aMVXL.jpeg" alt="">
</div>

<!-- Logo -->
<img id="logo" src="https://i.imgur.com/o8Z4h35.png" alt="Logo Flotte">

<div id="main">
  <header>Datapad ‚Äì Corps M√©dical Omega</header>

  <!-- Top menu: Profil / Membre -->
  <div class="top-left">
    <div class="profile-pill" id="membersBtn">Membres publics</div>
  </div>
  <div class="top-menu">
    <div class="profile-pill" id="profileBtn" style="display:none">Profil</div>
    <div class="profile-pill" id="authBtn">Se connecter / S'inscrire</div>
  </div>

  <div style="text-align:center; margin:10px 0;">
    <input type="text" id="searchInput" placeholder="Rechercher un document..." style="padding:8px 10px; border-radius:6px; border:2px solid #00eaff; width:250px; color:#00eaff; background:rgba(0,10,20,0.7);">
  </div>

  <!-- Horloges de mission centr√©es -->
  <div class="mission-timers" aria-hidden="false">
    <div class="mission-box" role="status" aria-live="polite">
      <h3>Mission 1 ‚Äì 18h00</h3>
      <div class="countdown" id="mission18">--:--:--</div>
    </div>
    <div class="mission-box" role="status" aria-live="polite">
      <h3>Mission 2 ‚Äì 21h00</h3>
      <div class="countdown" id="mission21">--:--:--</div>
    </div>
  </div>

  <div id="docButtons">
    <div class="button" data-url="https://google.com/">Fonctionnalit√© en Jeu</div>
    <div class="button" data-url="https://docs.google.com/spreadsheets/d/18InmloXNjy40ZFQsLcLay0vT1HR999Jjnz8naUmggJw/edit?gid=1198857426#gid=1198857426">Acc√©der √† l'Organigramme</div>
    <div class="button" data-url="https://google.com/">Documents Formation</div>
    <div class="button" data-url="https://google.com/">Sp√©cialisation</div>
    <div class="button" id="majBtn">Mise √† Jour</div>
  </div>

  <div class="info">
    <h2>Information Importante</h2>
    <p>
      Site officiel du Corps M√©dical de la Flotte Omega ‚Äì Tous droits r√©serv√©s.<br><br>
      Le Datapad est encore en cours de d√©veloppement.<br><br>
      Toute suggestion ou bug rencontr√© est √† signaler via le Holocom Discord : <strong>vincent_fr75</strong>
    </p>
  </div>

  <div class="marquee"><p>DataPad en cours de d√©veloppement - R√©alis√© par la Direction du Corps M√©dical !</p></div>

  <div style="text-align:center;">
    <a href="https://discord.gg/KtfyxQef" target="_blank" class="discord">üí¨ Discord Flotte Omega</a>
  </div>
</div>

<div id="viewer">
  <div class="scan" id="scanEffect"></div>
  <button id="backBtn">‚üµ Retour</button>
  <iframe id="docFrame"></iframe>
</div>

<!-- Public member list (profil public) -->
<div class="member-list" id="memberList" aria-live="polite">
  <strong>Membres publics</strong>
  <div id="membersContainer"></div>
</div>

<!-- Auth modal -->
<div class="auth-modal" id="authModal">
  <div class="auth-card" id="authCard">
    <!-- content injected by JS -->
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
/* ------------------------------------------------------------------
  IMPORTANT : Remplacez SUPABASE_URL et SUPABASE_ANON_KEY par vos valeurs.
  L'utilisateur a fourni le projet dashboard id, mais vous devez utiliser
  l'URL publique du projet (ex: https://xyzabc.supabase.co).
  ------------------------------------------------------------------ */
const SUPABASE_URL = 'https://lshfzzwkcxasvzfcaixg.supabase.co'; // suggestion bas√©e sur ton ID de projet
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzaGZ6endrY3hhc3Z6ZmNhaXhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NTI1MTMsImV4cCI6MjA3NTQyODUxM30.xQCFo6Z0swmKCR7uZLZaZveZXaknI1xKnszCU4Q6VSI';

const supabase = supabaseCreateClient(SUPABASE_URL, SUPABASE_ANON_KEY);
function supabaseCreateClient(url, key){
  return window.supabase = supabasejs.createClient(url, key);
}

/* UI hooks */
const authBtn = document.getElementById('authBtn');
const profileBtn = document.getElementById('profileBtn');
const profileModal = document.getElementById('authModal');
const authCard = document.getElementById('authCard');
const membersBtn = document.getElementById('membersBtn');
const membersContainer = document.getElementById('membersContainer');
const docButtons = document.getElementById('docButtons');

/* State */
let currentUser = null;
let currentProfile = null;

/* Roles allowed */
const GRADES_ALLOWED = [
  'Staff OMEGA',
  'M√©decin Standard',
  'Membre du Conseil M√©dical',
  \"Superviseur de l'ordre m√©dical\"
];

function openAuthModal(mode='login'){ profileModal.style.display='flex'; renderAuth(mode); }
function closeAuthModal(){ profileModal.style.display='none'; }

function renderAuth(mode){
  if(mode==='login'){
    authCard.innerHTML = `
      <h3>Connexion</h3>
      <input id="loginEmail" type="email" placeholder="Email">
      <input id="loginPass" type="password" placeholder="Mot de passe">
      <div class="auth-actions">
        <button id="doLogin" class="button">Se connecter</button>
        <div>
          <div class="small-link" id="toRegister">S'inscrire</div>
          <div class="small-link" id="toForgot">Mot de passe oubli√©</div>
        </div>
      </div>
      <div style="margin-top:8px; text-align:right"><button class="button" id="closeAuth">Fermer</button></div>
    `;
    document.getElementById('toRegister').onclick = ()=> renderAuth('register');
    document.getElementById('toForgot').onclick = ()=> renderAuth('forgot');
    document.getElementById('doLogin').onclick = doLogin;
    document.getElementById('closeAuth').onclick = closeAuthModal;
  } else if(mode==='register'){
    authCard.innerHTML = `
      <h3>Inscription</h3>
      <input id="regEmail" type="email" placeholder="Email">
      <input id="regPass" type="password" placeholder="Mot de passe (min 6)">
      <input id="regName" type="text" placeholder="Nom complet">
      <input id="regGrade" type="text" placeholder="Grade (ex: M√©decin Standard)">
      <input id="regRegiment" type="text" placeholder="R√©giment">
      <input id="regFonction" type="text" placeholder="Fonction">
      <input id="regMatricule" type="text" placeholder="Matricule">
      <input id="regNickname" type="text" placeholder="Surnom (optionnel)">
      <div class="auth-actions">
        <button id="doRegister" class="button">S'inscrire</button>
        <div><div class="small-link" id="toLogin">Se connecter</div></div>
      </div>
      <div style="margin-top:8px; text-align:right"><button class="button" id="closeAuth">Fermer</button></div>
    `;
    document.getElementById('toLogin').onclick = ()=> renderAuth('login');
    document.getElementById('doRegister').onclick = doRegister;
    document.getElementById('closeAuth').onclick = closeAuthModal;
  } else if(mode==='forgot'){
    authCard.innerHTML = `
      <h3>Mot de passe oubli√©</h3>
      <input id="forgotEmail" type="email" placeholder="Votre email enregistr√©">
      <div class="auth-actions">
        <button id="doForgot" class="button">Envoyer lien de r√©initialisation</button>
        <div><div class="small-link" id="toLogin">Se connecter</div></div>
      </div>
      <div style="margin-top:8px; text-align:right"><button class="button" id="closeAuth">Fermer</button></div>
    `;
    document.getElementById('toLogin').onclick = ()=> renderAuth('login');
    document.getElementById('doForgot').onclick = doForgot;
    document.getElementById('closeAuth').onclick = closeAuthModal;
  }
}

/* Supabase actions */
async function doRegister(){
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPass').value;
  const full_name = document.getElementById('regName').value.trim();
  const grade = document.getElementById('regGrade').value.trim();
  const regiment = document.getElementById('regRegiment').value.trim();
  const fonction = document.getElementById('regFonction').value.trim();
  const matricule = document.getElementById('regMatricule').value.trim();
  const nickname = document.getElementById('regNickname').value.trim();

  if(!email || !password || !full_name){ alert('Remplissez au moins l\\'email, le mot de passe et le nom complet.'); return; }
  const { data, error } = await supabase.auth.signUp({ email, password });
  if(error){ alert('Erreur inscription : ' + error.message); return; }

  const profile = { id: data.user.id, full_name, grade, regiment, fonction, matricule, nickname };
  const { error: err2 } = await supabase.from('profiles').upsert(profile);
  if(err2){ console.warn(err2); alert('Inscription r√©ussie (v√©rifiez votre mail). Erreur lors de cr√©ation du profil : ' + err2.message); }
  else { alert('Inscription r√©ussie. V√©rifiez votre mail pour confirmer (si activ√©).'); closeAuthModal(); }
}

async function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPass').value;
  if(!email || !password){ alert('Email et mot de passe requis'); return; }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ alert('Erreur connexion : ' + error.message); return; }
  closeAuthModal();
}

async function doForgot(){
  const email = document.getElementById('forgotEmail').value.trim();
  if(!email){ alert('Entrez votre email'); return; }
  const { data, error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
  if(error){ alert('Erreur : ' + error.message); }
  else { alert('Si un compte existe, vous allez recevoir un e-mail avec les instructions.'); closeAuthModal(); }
}

async function loadProfile(user){
  if(!user) { currentProfile = null; currentUser = null; updateUIForUser(); return; }
  currentUser = user;
  const { data: profiles, error } = await supabase.from('profiles').select('*').eq('id', user.id).limit(1).single();
  if(error){ console.warn('profile fetch', error); currentProfile = null; }
  else currentProfile = profiles;
  updateUIForUser();
}

function updateUIForUser(){
  if(currentUser){
    authBtn.textContent = 'D√©connexion';
    profileBtn.style.display = 'inline-block';
  } else {
    authBtn.textContent = 'Se connecter / S\\'inscrire';
    profileBtn.style.display = 'none';
  }

  let allowed = false;
  if(currentProfile && GRADES_ALLOWED.includes(currentProfile.grade)) allowed = true;
  document.getElementById('docButtons').style.display = allowed ? 'block' : 'none';
}

/* Logout */
authBtn.addEventListener('click', async ()=>{
  if(currentUser){
    await supabase.auth.signOut();
  } else {
    openAuthModal('login');
  }
});

/* Profile button */
profileBtn.addEventListener('click', async ()=>{
  if(!currentUser){ openAuthModal('login'); return; }
  let html = `<h3>Profil : ${currentProfile?.full_name ?? '‚Äî'}</h3>`;
  html += `<p>Grade : ${currentProfile?.grade ?? '‚Äî'}</p>`;
  html += `<p>R√©giment : ${currentProfile?.regiment ?? '‚Äî'}</p>`;
  html += `<p>Fonction : ${currentProfile?.fonction ?? '‚Äî'}</p>`;
  html += `<p>Matricule : ${currentProfile?.matricule ?? '‚Äî'}</p>`;
  html += `<p>Surnom : ${currentProfile?.nickname ?? '‚Äî'}</p>`;
  if(currentProfile && currentProfile.grade === \"Superviseur de l'ordre m√©dical\"){
    html += `<hr><p><strong>Actions Superviseur</strong></p>`;
    html += `<p><button id=\"btnSendReset\" class=\"button\">R√©initialiser mot de passe (admin)</button></p>`;
  }
  html += `<div style=\"text-align:right\"><button id=\"closeProfile\" class=\"button\">Fermer</button></div>`;
  authCard.innerHTML = html;
  profileModal.style.display = 'flex';
  document.getElementById('closeProfile').onclick = ()=> profileModal.style.display='none';
  const btnSendReset = document.getElementById('btnSendReset');
  if(btnSendReset){
    btnSendReset.onclick = async ()=>{
      const targetEmail = prompt('Email du membre √† r√©initialiser :');
      if(!targetEmail) return alert('Annul√©');
      // Appel de la Netlify Function admin_reset
      try {
        const resp = await fetch('/.netlify/functions/admin_reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: targetEmail, requesterGrade: currentProfile.grade })
        });
        const json = await resp.json();
        if(!resp.ok) throw new Error(json.error || 'Erreur');
        alert('R√©initialisation demand√©e : le membre recevra un mot de passe temporaire.');
      } catch (err) {
        alert('Erreur lors de la demande : ' + err.message);
      }
    }
  }
});

/* Members list public */
membersBtn.addEventListener('click', async ()=>{
  const ml = document.getElementById('memberList');
  ml.style.display = (ml.style.display === 'none' || !ml.style.display) ? 'block' : 'none';
});

async function loadPublicMembers(){
  const { data, error } = await supabase.from('profiles').select('id, full_name, grade, regiment, nickname').limit(100);
  if(error){ console.warn(error); return; }
  membersContainer.innerHTML = data.map(m => `
    <div class=\"member-item\"><strong>${m.full_name}</strong><br>${m.grade} ‚Äî ${m.regiment || ''} ${m.nickname ? ' ‚Äî \"'+m.nickname+'\"' : ''}</div>`).join('');
}

/* Buttons iframe behavior unchanged */
const buttons = document.querySelectorAll('.button[data-url]');
const viewer = document.getElementById('viewer');
const docFrame = document.getElementById('docFrame');
const main = document.getElementById('main');
const scan = document.getElementById('scanEffect');

buttons.forEach(btn => {
  btn.addEventListener('click', () => {
    scan.style.opacity = '1';
    setTimeout(() => scan.style.opacity = '0', 500);
    docFrame.src = btn.dataset.url;
    viewer.style.display = 'block';
    main.style.display = 'none';
    try { new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3').play(); } catch(e) {}
  });
});

document.getElementById('backBtn').addEventListener('click', ()=>{
  docFrame.src='';
  viewer.style.display='none';
  main.style.display='block';
  try { new Audio('https://freesound.org/data/previews/256/256114_3263906-lq.mp3').play(); } catch(e) {}
});

/* Search filter */
document.getElementById('searchInput').addEventListener('input', e=>{
  const val = e.target.value.toLowerCase();
  buttons.forEach(btn=>{
    btn.style.display = btn.textContent.toLowerCase().includes(val) ? 'block' : 'none';
  });
});

/* Dev keys restrictions */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', function(e){
  if(e.key==='F12' || (e.ctrlKey && e.shiftKey && e.key.toUpperCase()==='I') || (e.ctrlKey && e.key.toUpperCase()==='U') || (e.ctrlKey && e.key.toUpperCase()==='S')){
    e.preventDefault();
    alert('Acc√®s restreint mon ptit lou ;)');
  }
});

/* Mission clocks */
function updateCountdown(targetHour, elementId) {
  const now = new Date();
  const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), targetHour, 0, 0, 0);
  if (now >= target) { target.setDate(target.getDate() + 1); }
  const diff = target - now;
  const hrs = Math.floor((diff / (1000 * 60 * 60)));
  const mins = Math.floor((diff / (1000 * 60)) % 60);
  const secs = Math.floor((diff / 1000) % 60);
  const el = document.getElementById(elementId);
  if (diff <= 0) {
    el.textContent = "MISSION EN COURS";
    el.classList.add("active");
  } else {
    const display = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    el.textContent = display;
    el.classList.remove("active");
  }
}
setInterval(() => {
  updateCountdown(18, "mission18");
  updateCountdown(21, "mission21");
}, 1000);
updateCountdown(18, "mission18");
updateCountdown(21, "mission21");

/* notifications */
let lastState18 = null;
let lastState21 = null;
function checkAndAlert() {
  const el18 = document.getElementById('mission18');
  const el21 = document.getElementById('mission21');
  const state18 = el18.classList.contains('active');
  const state21 = el21.classList.contains('active');
  if (state18 && !lastState18) {
    try { new Audio('https://freesound.org/data/previews/401/401999_5121236-lq.mp3').play(); } catch(e) {}
  }
  if (state21 && !lastState21) {
    try { new Audio('https://freesound.org/data/previews/401/401999_5121236-lq.mp3').play(); } catch(e) {}
  }
  lastState18 = state18;
  lastState21 = state21;
}
setInterval(checkAndAlert, 1000);

/* Supabase onAuthStateChange */
supabase.auth.onAuthStateChange((event, session) => {
  if(session && session.user) loadProfile(session.user);
  else loadProfile(null);
});

// on load
(async ()=>{
  const { data: { user } } = await supabase.auth.getUser();
  if(user) loadProfile(user);
  loadPublicMembers();
})();

</script>
</body>
</html>
