<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DataPad – Corps Médical OMEGA</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
<style>
/* ============================
   Styles principaux
   ============================ */
:root{
  --accent: #00eaff;
  --bg-soft: rgba(0,10,20,0.7);
}
body{
  margin:0;
  font-family: 'Orbitron', sans-serif;
  background:#000;
  color:var(--accent);
  overflow-x:hidden;
}

/* Header / logo */
header{
  text-align:center;
  font-size:2rem;
  font-weight:bold;
  text-shadow:0 0 10px var(--accent), 0 0 20px #007bff;
  border-bottom:2px solid var(--accent);
  padding:48px 20px 20px;
  margin:10px auto;
  position:relative;
}
#logo{ position:absolute; top:18px; left:18px; width:70px; animation:rotateLogo 8s linear infinite; filter:drop-shadow(0 0 8px rgba(0,234,255,0.35)); }
@keyframes rotateLogo{ 0%{transform:rotateY(0deg)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)} }

/* Discord link styling (couleurs Discord) */
.discord{
  display:inline-block;
  padding:10px 20px;
  border:2px solid #5865F2;
  border-radius:8px;
  color:#ffffff;
  background-color:#5865F2;
  text-decoration:none;
  font-weight:bold;
  box-shadow:0 0 10px rgba(88,101,242,0.5);
  transition:all .3s ease;
}
.discord:hover{
  background-color:#7289da;
  box-shadow:0 0 20px rgba(88,101,242,0.8);
}

/* Background slideshow */
.background{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:-2; overflow:hidden; }
.background img{ position:absolute; width:100%; height:100%; object-fit:cover; opacity:0; animation:fadeSlideshow 24s infinite; }
.background img:nth-child(1){ animation-delay:0s } .background img:nth-child(2){ animation-delay:8s } .background img:nth-child(3){ animation-delay:16s }
@keyframes fadeSlideshow{ 0%{opacity:0} 10%{opacity:1} 30%{opacity:1} 40%{opacity:0} 100%{opacity:0} }

/* Mission timers */
.mission-timers{ display:flex; justify-content:center; gap:30px; margin:16px auto 6px; padding:0 10px; z-index:5; position:relative; }
.mission-box{ background:var(--bg-soft); border:1px solid rgba(0,234,255,0.18); border-left:2px solid var(--accent); border-right:2px solid var(--accent); border-radius:10px; padding:10px 18px; width:220px; box-shadow:0 0 16px rgba(0,234,255,0.12); text-align:center; backdrop-filter: blur(4px); }
.mission-box h3{ margin:0 0 6px; font-size:0.95rem; color:#9ef2ff; letter-spacing:1px; text-shadow:0 0 6px rgba(0,234,255,0.12); }
.countdown{ font-size:1.3rem; font-weight:800; color:#dffcff; text-shadow:0 0 10px rgba(0,170,255,0.15); }

/* Buttons */
.button{
  display:block;
  width:260px;
  margin:15px auto;
  padding:12px;
  background:rgba(0,20,40,0.8);
  border:2px solid var(--accent);
  color:var(--accent);
  text-align:center;
  font-weight:bold;
  border-radius:8px;
  cursor:pointer;
  transition:all .25s ease;
}
.button:hover{ background:var(--accent); color:#000; box-shadow:0 0 15px var(--accent); }

/* Document buttons container */
#docButtons{ margin-top:8px; }

/* Login container (style original sobre) */
.login-container{
  background:var(--bg-soft);
  border:1px solid var(--accent);
  border-radius:12px;
  padding:22px;
  box-shadow:0 0 15px rgba(0,234,255,0.18);
  width:340px;
  margin:40px auto;
  text-align:center;
}
.login-container h2{ color:var(--accent); margin:0 0 16px; text-shadow:0 0 8px var(--accent); }

/* Inputs */
.rdvInput{ width:90%; margin:6px auto; padding:10px; border:2px solid var(--accent); background:black; color:var(--accent); border-radius:6px; font-family:'Orbitron',sans-serif; }

/* Info block */
.info{ text-align:center; margin:30px auto; max-width:600px; padding:20px; background:var(--bg-soft); border:1px solid var(--accent); border-radius:12px; box-shadow:0 0 15px rgba(0,234,255,0.3); font-size:1.05rem; line-height:1.6; }
.info h2{ color:var(--accent); margin-bottom:12px; }

/* Marquee */
.marquee{ width:100%; overflow:hidden; white-space:nowrap; box-sizing:border-box; border-top:1px solid var(--accent); border-bottom:1px solid var(--accent); margin:10px 0; }
.marquee p{ display:inline-block; padding-left:100%; animation:scrollText 60s linear infinite; font-weight:bold; }
@keyframes scrollText{ 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }

/* Viewer overlay (iframe) */
#viewer{ display:none; position:fixed; inset:0; z-index:1000; background:#000; }
#viewer .panel{ position:relative; width:100%; height:100%; }
#viewer iframe{ width:100%; height:100%; border:0; display:block; background:#fff; }
#viewer .controls{ position:absolute; top:12px; left:12px; z-index:1010; display:flex; gap:8px; }
#viewer .controls .small-btn{ padding:8px 12px; border-radius:6px; border:2px solid var(--accent); background:rgba(0,10,20,0.7); color:var(--accent); cursor:pointer; font-weight:bold; }

/* Responsive */
@media screen and (max-width:768px){
  header{ font-size:1.6rem; padding-top:40px; }
  .button{ width:80%; padding:10px; font-size:1rem; }
  .mission-timers{ flex-direction:column; gap:12px; margin-top:90px; }
  .mission-box{ width:86%; max-width:320px; }
  .login-container{ width:92%; margin:20px auto; }
}
</style>
</head>
<body>

<!-- Background slideshow images -->
<div class="background">
  <img src="https://i.imgur.com/f7PWoZV.jpeg" alt="">
  <img src="https://i.imgur.com/APBvYRx.jpeg" alt="">
  <img src="https://i.imgur.com/18aMVXL.jpeg" alt="">
</div>

<!-- Logo and header -->
<img id="logo" src="https://i.imgur.com/o8Z4h35.png" alt="Logo">
<header>Datapad – Corps Médical Omega</header>

<!-- Mission timers -->
<div class="mission-timers">
  <div class="mission-box">
    <h3>Mission 1 – 18h00</h3>
    <div class="countdown" id="mission18">--:--:--</div>
  </div>
  <div class="mission-box">
    <h3>Mission 2 – 21h00</h3>
    <div class="countdown" id="mission21">--:--:--</div>
  </div>
</div>

<!-- Document buttons: hidden until Medic connecté -->
<div id="docButtons" style="display:none;">
  <div class="button" data-url="https://google.com/">Fonctionnalité en Jeu</div>
  <div class="button" data-url="https://docs.google.com/spreadsheets/d/18InmloXNjy40ZFQsLcLay0vT1HR999Jjnz8naUmggJw/edit?gid=1198857426#gid=1198857426">Organigramme</div>
  <div class="button" data-url="https://google.com/">Documents Formation</div>
  <div class="button" data-url="https://google.com/">Spécialisation</div>
  <div class="button" id="majBtn">Mise à Jour</div>
  <!-- Bouton Demandes de RDV (ouvre ta Google Sheet dans le viewer après confirmation) -->
  <div class="button" id="demandesRdvBtn" data-url="https://docs.google.com/spreadsheets/d/1e3zF5MB9Y6vnui428mabJf121rOcj9FAtO2V8SgvLfw/edit?gid=0">Demandes de RDV</div>
</div>

<!-- Login box (style original) -->
<div id="loginBox" class="login-container">
  <h2>Connexion Médic</h2>
  <input id="loginUser" type="text" placeholder="Identifiant" class="rdvInput" autocomplete="username">
  <input id="loginPass" type="password" placeholder="Mot de passe" class="rdvInput" autocomplete="current-password">
  <button id="loginBtn" class="button" style="width:200px;">Se connecter</button>
</div>

<!-- Logout button (visible après login) -->
<div id="logoutBox" style="display:none; text-align:center; margin-top:20px;">
  <button id="logoutBtn" class="button" style="width:200px;background:#ff4545;border-color:#ff4545;">Se déconnecter</button>
</div>

<!-- Formulaire RDV (accessible à tous) -->
<div id="rdvBox" style="text-align:center; margin:40px auto; max-width:420px; background:rgba(0,10,20,0.7); padding:20px; border:1px solid var(--accent); border-radius:10px; box-shadow:0 0 15px rgba(0,234,255,0.3);">
  <h2>Prise de rendez-vous médical</h2>
  <form id="rdvForm">
    <input id="regiment" class="rdvInput" type="text" placeholder="Régiment" required><br>
    <input id="grade" class="rdvInput" type="text" placeholder="Grade" required><br>
    <input id="matricule" class="rdvInput" type="text" placeholder="Matricule" required><br>
    <input id="nom" class="rdvInput" type="text" placeholder="Nom" required><br>
    <input id="dateDemande" class="rdvInput" type="date" required><br>
    <textarea id="raison" class="rdvInput" placeholder="Raison du rendez-vous" required style="height:90px;"></textarea><br>
    <button type="submit" class="button" style="width:100%;">Envoyer la demande</button>
  </form>
  <p id="formMsg" style="color:#9ef2ff; margin-top:8px; font-size:0.95rem;">Les demandes seront transmises au bureau médical.</p>
</div>

<!-- Info publique -->
<div class="info">
  <h2>Information importante</h2>
  <p>
    Site officiel du Corps Médical de la Flotte Omega – Tous droits réservés.<br><br>
    Le Datapad est en cours de développement.<br><br>
    Signaler suggestions/bugs via Discord : <strong>vincent_fr75</strong>
  </p>
</div>

<div class="marquee"><p>DataPad en cours de développement - Réalisé par la Direction du Corps Médical</p></div>

<div style="text-align:center; margin-bottom:40px;">
  <a class="discord" href="https://discord.gg/wDARBFh8kt" target="_blank" rel="noopener">Discord Flotte Omega</a>
</div>

<!-- Viewer overlay (iframe) -->
<div id="viewer" aria-hidden="true">
  <div class="panel">
    <!-- Controls: back (bouton "Ouvrir dans un nouvel onglet" supprimé) -->
    <div class="controls">
      <button id="backViewer" class="small-btn" title="Retour">⟵ Retour</button>
    </div>
    <iframe id="docFrame" src=""></iframe>
  </div>
</div>

<!-- ============================
     SCRIPT - comportement
     ============================ -->
<script>
/* ============================
   Configuration (à ne pas changer)
   ============================ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVIttDw5nEYb6NHIJDV6F8yXjUW2tTtdKi5DTWBF4THl0kXIfr6wXrjc1vlqAworoG/exec";
const MEDIC_USER = "UserMedic01";
const MEDIC_PASS = "1489";

/* ============================
   DOM references
   ============================ */
const loginBox = document.getElementById('loginBox');
const logoutBox = document.getElementById('logoutBox');
const docButtons = document.getElementById('docButtons');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const rdvForm = document.getElementById('rdvForm');
const formMsg = document.getElementById('formMsg');
const demandesRdvBtn = document.getElementById('demandesRdvBtn');

/* Viewer */
const viewer = document.getElementById('viewer');
const docFrame = document.getElementById('docFrame');
const backViewer = document.getElementById('backViewer');
// Note: bouton "openNewTab" supprimé volontairement (conformément à la demande)

/* ============================
   Audio / scan sound
   - simple rising effect, reused on button clicks
   ============================ */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  return audioCtx;
}
function playScanSound(){
  try{
    const ctx = ensureAudio();
    const now = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(420, now);
    o.frequency.exponentialRampToValueAtTime(1200, now + 0.22);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.linearRampToValueAtTime(0.16, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
    o.connect(g); g.connect(ctx.destination);
    o.start(now); o.stop(now + 0.65);

    // small tick
    const o2 = ctx.createOscillator();
    const g2 = ctx.createGain();
    o2.type = 'triangle';
    o2.frequency.setValueAtTime(1800, now + 0.06);
    g2.gain.setValueAtTime(0.0001, now + 0.06);
    g2.gain.linearRampToValueAtTime(0.06, now + 0.08);
    g2.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
    o2.connect(g2); g2.connect(ctx.destination);
    o2.start(now + 0.06); o2.stop(now + 0.2);
  }catch(e){
    // ignore audio errors (browser restrictions)
    console.warn('Audio error', e);
  }
}

/* Attach scan sound to any button with .button (visual/audio feedback) */
document.addEventListener('click', function(evt){
  const el = evt.target.closest('.button');
  if(el) playScanSound();
});

/* ============================
   Login / logout logic (client-side)
   - stores state in localStorage for persistence
   - also saves identifiant/mdp comme demandé
   ============================ */
function setMedicView(isMedic){
  docButtons.style.display = isMedic ? 'block' : 'none';
  loginBox.style.display = isMedic ? 'none' : 'block';
  logoutBox.style.display = isMedic ? 'block' : 'none';
}
window.addEventListener('load', ()=>{
  const logged = localStorage.getItem('medicLogged') === '1';
  setMedicView(logged);

  // Restauration des identifiants/mot de passe sauvegardés (si présents)
  const savedUser = localStorage.getItem('savedUser') || '';
  const savedPass = localStorage.getItem('savedPass') || '';
  if(document.getElementById('loginUser')) document.getElementById('loginUser').value = savedUser;
  if(document.getElementById('loginPass')) document.getElementById('loginPass').value = savedPass;
});

/* Login button */
loginBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(u === MEDIC_USER && p === MEDIC_PASS){
    localStorage.setItem('medicLogged','1');
    // Sauvegarde des identifiants et mdp (conforme à la demande)
    localStorage.setItem('savedUser', u);
    localStorage.setItem('savedPass', p);
    setMedicView(true);
    alert('Connexion réussie');
  } else {
    alert('Identifiant ou mot de passe incorrect.');
  }
});

/* Logout button */
logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem('medicLogged');
  setMedicView(false);
  alert('Déconnecté');
});

/* ============================
   Document buttons behavior
   - Open in viewer if medic
   - Otherwise show restricted message
   ============================ */
document.querySelectorAll('#docButtons .button').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const isMedic = localStorage.getItem('medicLogged') === '1';
    const url = btn.dataset.url;
    if(!isMedic){
      alert('Accès réservé au personnel médical. Connectez-vous.');
      return;
    }
    if(!url){
      // special buttons with no data-url (e.g. Mise à Jour) - treat separately if needed
      return;
    }
    // For the "Demandes de RDV" button we want a confirmation
    if(btn.id === 'demandesRdvBtn'){
      const confirmed = confirm('Voulez-vous ouvrir les demandes de RDV dans le viewer intégré ?');
      if(!confirmed) return;
    }
    openInViewer(url);
  });
});

/* Opens a url in the overlay iframe viewer.
   If the iframe is blocked by the server (X-Frame-Options), the iframe peut ne pas s'afficher.
*/
function openInViewer(url){
  // set the iframe src then display the viewer
  docFrame.src = url;
  viewer.style.display = 'block';
  viewer.setAttribute('aria-hidden','false');

  // Note: le bouton "Ouvrir dans un nouvel onglet" a été supprimé volontairement.
}

/* Close viewer */
backViewer.addEventListener('click', ()=>{
  viewer.style.display = 'none';
  viewer.setAttribute('aria-hidden','true');
  // clear src to stop media
  docFrame.src = '';
});

/* Also close viewer if user hits Escape */
document.addEventListener('keydown', function(e){
  if(e.key === 'Escape' && viewer.style.display === 'block'){
    backViewer.click();
  }
});

/* Clicking a data-url button will play sound (attached globally) and open viewer; done above */

/* ============================
   RDV form submission
   - Sends the data to Google Apps Script (SCRIPT_URL)
   - Uses mode:'no-cors' to avoid CORS issues for simple Apps Script deployments
   - Shows a friendly confirmation after send
   ============================ */
rdvForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const payload = {
    regiment: document.getElementById('regiment').value.trim(),
    grade: document.getElementById('grade').value.trim(),
    matricule: document.getElementById('matricule').value.trim(),
    nom: document.getElementById('nom').value.trim(),
    dateDemande: document.getElementById('dateDemande').value,
    raison: document.getElementById('raison').value.trim()
  };

  // Basic validation
  if(!payload.regiment || !payload.grade || !payload.matricule || !payload.nom || !payload.dateDemande || !payload.raison){
    alert('Merci de remplir tous les champs requis.');
    return;
  }

  formMsg.textContent = 'Envoi en cours...';

  try{
    // Using no-cors since Apps Script web app often doesn't return CORS headers.
    // The request will still be delivered to the Apps Script if deployed to "Anyone, even anonymous".
    await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    // We cannot reliably read a response in no-cors mode, so assume success if no network error
    formMsg.textContent = 'Demande envoyée avec succès.';
    rdvForm.reset();
    setTimeout(()=> formMsg.textContent = 'Les demandes seront transmises au bureau médical.', 3000);
  }catch(err){
    console.error(err);
    formMsg.textContent = 'Erreur lors de l\'envoi. Vérifiez la connexion.';
    alert('Erreur lors de l\'envoi. Voir la console pour plus de détails.');
  }
});

/* ============================
   Horloge missions (update chaque seconde)
   ============================ */
function updateMissionTimers(){
  const now = new Date();
  function diff(targetHour){
    let t = new Date();
    t.setHours(targetHour,0,0,0);
    if(t < now) t.setDate(t.getDate() + 1);
    return t - now;
  }
  function fmt(ms){
    const h = Math.floor(ms / 36e5);
    const m = Math.floor(ms / 6e4) % 60;
    const s = Math.floor(ms / 1e3) % 60;
    return [h,m,s].map(x => x.toString().padStart(2,'0')).join(':');
  }
  document.getElementById('mission18').textContent = fmt(diff(18));
  document.getElementById('mission21').textContent = fmt(diff(21));
}
setInterval(updateMissionTimers, 1000);
updateMissionTimers();

/* ============================
   Small protections/dissuasion (optional)
   - Prevent default context menu and some dev keys
   ============================ */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', function(e){
  if(e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key.toUpperCase()==='I') || (e.ctrlKey && e.key.toUpperCase()==='U')){
    e.preventDefault();
    alert('Accès restreint.');
  }
});
</script>

</body>
</html>
